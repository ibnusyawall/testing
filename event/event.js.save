const fs = require('fs')
const util = require('util')
const path = require('path')
const FileType = require('file-type')
const fetch = require('node-fetch')
const { spawn } = require('child_process')
const { MessageType } = require('@adiwajshing/baileys')


exports.WAConnection = (_WAConnection) => {
    class WAConnection extends _WAConnection {
        constructor(...args) {
            super(...args)
            if (!Array.isArray(this._events['CB:action,add:relay,message'])) this._events['CB:action,add:relay,message'] = [this._events['CB:action,add:relay,message']]
            else this._events['CB:action,add:relay,message'] = [this._events['CB:action,add:relay,message'].pop()]

            this._events['CB:action,add:relay,message'].unshift(async function (json) {
                try {
                    let m = json[2][0][2]
                    if (m.message && m.message.protocolMessage && m.message.protocolMessage.type == 0) {
                        let key = m.message.protocolMessage.key
                        let c = this.chats.get(key.remoteJid)
                        let a = c.messages.dict[`${key.id}|${key.fromMe ? 1 : 0}`]
                        let participant = key.fromMe ? this.user.jid : a.participant ? a.participant : key.remoteJid
                        let WAMSG = a.constructor
                        this.emit('message-delete', { key, participant, message: WAMSG.fromObject(WAMSG.toObject(a)) })
                    }
                } catch (e) {}
            })
        }

        async copyNForward(jid, message, idk = false, options = {}) {
            let mtype   = Object.keys(message.message)[0]
            let content = await this.generateForwardMessageContent(message, idk)
            let ctype   = Object.keys(content)[0]
            let context = {}
            if (mtype != MessageType.text) context = message.message[mtype].contextInfo
            content[ctype].contextInfo = {
                ...context,
                ...content[ctype].contextInfo
            }
            const waMessage = await this.prepareMessageFromContent(jid, content, options)
            await this.relayWAMessage(waMessage)
            return waMessage
        }

        _batere() {
            this.on(['action', null, 'battery'], json => {
                let status = json[2][0][1].value
                return parseInt(status)
            })
        }

        toJSON(json) {
            if (typeof json != 'object') return 'only object'

            return JSON.stringify(json, null, '\t')
        }

    }
}
